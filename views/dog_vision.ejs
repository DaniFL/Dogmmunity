<%- include("header", { title: title }) %>

<main id="main" class="main">
  <section class="dog-vision-section">
    <div class="container text-center py-5">
      <h2 class="section-title">Simulador de Visión Perruna</h2>
      <p class="section-description">Sube una imagen para ver el antes y después desde la perspectiva de un perro.</p>

      <!-- Formulario para subir la imagen -->
      <input type="file" id="imageInput" class="form-control my-3" accept="image/*" required>
      <button id="processButton" class="btn btn-primary">Simular Visión Perruna</button>

      <!-- Contenedor del antes y después -->
      <div id="previewContainer" class="mt-4" style="display: none;">
        <!-- <h4>Antes y Después:</h4> -->
        <div class="row">
          <div class="col-md-6">
            <h5>POV: eres humano</h5>
            <canvas id="originalCanvas" class="img-fluid rounded shadow"></canvas>
          </div>
          <div class="col-md-6">
            <h5>POV: eres un perro</h5>
            <canvas id="processedCanvas" class="img-fluid rounded shadow"></canvas>
          </div>
        </div>
        <div class="mt-3">
          <a id="downloadLink" href="#" download="dog_vision.jpg" class="btn btn-success">Descargar Imagen Procesada</a>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const imageInput = document.getElementById('imageInput');
  const processButton = document.getElementById('processButton');
  const originalCanvas = document.getElementById('originalCanvas');
  const processedCanvas = document.getElementById('processedCanvas');
  const previewContainer = document.getElementById('previewContainer');
  const downloadLink = document.getElementById('downloadLink');

  // Función para aplicar el filtro de visión de perro
  function simulateDogVision(ctx, image) {
    const { width, height } = processedCanvas;
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
      const red = data[i];
      const green = data[i + 1];
      const blue = data[i + 2];

      // Simular visión dicromática (rojo-verde percibido como amarillo)
      data[i] = (red * 0.6 + green * 0.3); // Menos rojo, más amarillo
      data[i + 1] = (green * 0.7 + red * 0.2); // Intensificar verde
      data[i + 2] = blue * 1.1; // Mantener azul dominante

      // Opcional: Reducir nitidez o brillo para mayor realismo
      data[i] *= 0.9;
      data[i + 1] *= 0.9;
      data[i + 2] *= 0.9;
    }

    // Actualizar el canvas con los nuevos datos
    ctx.putImageData(imageData, 0, 0);
  }

  // Procesar la imagen cuando el usuario hace clic en el botón
  processButton.addEventListener('click', () => {
    if (!imageInput.files.length) {
      alert('Por favor, selecciona una imagen primero.');
      return;
    }

    const file = imageInput.files[0];
    const reader = new FileReader();

    reader.onload = () => {
      const image = new Image();
      image.onload = () => {
        // Configurar el canvas con las dimensiones de la imagen
        originalCanvas.width = image.width;
        originalCanvas.height = image.height;
        processedCanvas.width = image.width;
        processedCanvas.height = image.height;

        const originalCtx = originalCanvas.getContext('2d');
        const processedCtx = processedCanvas.getContext('2d');

        // Dibujar la imagen original en el canvas "antes"
        originalCtx.drawImage(image, 0, 0);

        // Dibujar la imagen en el canvas "después" y aplicar el filtro
        processedCtx.drawImage(image, 0, 0);
        simulateDogVision(processedCtx, image);

        // Mostrar los canvas y configurar el enlace de descarga
        previewContainer.style.display = 'block';
        downloadLink.href = processedCanvas.toDataURL('image/jpeg');
      };
      image.src = reader.result;
    };

    reader.readAsDataURL(file);
  });
</script>

<%- include("footer", {}) %>
